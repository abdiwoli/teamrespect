{% extends "layout.html" %}

{% block content %}
<header class="page-header">
    <div class="header-text">
        <h1>Xaadirinta Kooxda</h1>
        <p>Diwaangelinta imaanshaha xubnaha Team Respect.</p>
    </div>

    <div class="header-actions">
        {% if current_user.role == 'Admin' %}
        <button class="btn-success" onclick="finishMeeting()">
            <i class="fas fa-check-double"></i> Dhameystir (Finish)
        </button>
        {% endif %}
    </div>
</header>

<div class="attendance-card">
    <div class="date-selector">
        <button class="nav-btn" onclick="changeDate(-1)"><i class="fas fa-chevron-left"></i></button>
        <div class="current-date">
            <i class="fas fa-calendar-alt"></i>
            <span id="dateDisplay">{{ selected_date.strftime('%B %d, %Y') }}</span>
            <input type="date" id="dateInput" value="{{ selected_date }}" class="date-input hidden">
        </div>
        <button class="nav-btn" onclick="changeDate(1)"><i class="fas fa-chevron-right"></i></button>
    </div>

    <table class="attendance-table">
        <thead>
            <tr>
                <th>Member</th>
                <th class="text-center">Status</th>
            </tr>
        </thead>
        <tbody>
            {% for member in members %}
            <tr data-id="{{ member.id }}">
                <td class="member-info">
                    <div class="member-avatar">{{ member.name[0] }}</div>
                    <span class="member-name">{{ member.name }}</span>
                </td>
                <td class="text-center">
                    <div class="status-buttons">
                        {% if current_user.role == 'Admin' %}
                        <button
                            class="status-btn jooga {{ 'active' if attendance_map.get(member.id) == 'Jooga' else '' }}"
                            onclick="selectStatus({{ member.id }}, 'Jooga')">
                            <i class="fas fa-check"></i>
                        </button>
                        <button
                            class="status-btn maqan {{ 'active' if attendance_map.get(member.id) == 'Maqan' else '' }}"
                            onclick="selectStatus({{ member.id }}, 'Maqan')">
                            <i class="fas fa-times"></i>
                        </button>
                        <button
                            class="status-btn fasax {{ 'active' if attendance_map.get(member.id) == 'Fasax' else '' }}"
                            onclick="selectStatus({{ member.id }}, 'Fasax')">
                            <i class="fas fa-clock"></i>
                        </button>
                        {% else %}
                        <!-- Read Only View for Regular Users -->
                        {% if attendance_map.get(member.id) == 'Jooga' %}
                        <span class="badge success">Jooga</span>
                        {% elif attendance_map.get(member.id) == 'Maqan' %}
                        <span class="badge danger">Maqan</span>
                        {% elif attendance_map.get(member.id) == 'Fasax' %}
                        <span class="badge warning">Fasax</span>
                        {% else %}
                        <span class="badge secondary">-</span>
                        {% endif %}
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    {% if current_user.role == 'Admin' %}
    <div class="footer-actions"
        style="padding: 1rem; display: flex; justify-content: flex-end; border-top: 1px solid var(--glass-border);">
        <button id="submitAttendanceBtn" class="btn-primary" onclick="submitAttendance()">
            <i class="fas fa-save"></i> Save Attendance
        </button>
    </div>
    {% endif %}
</div>

<!-- Simple JS for this page -->
<script>
    async function deleteMember(id) {
        if (!confirm('Ma hubtaa inaad rabto inaad tirto xubintan? (Delete Member)')) return;

        try {
            const res = await fetch(`/api/delete_member/${id}`, { method: 'POST' });
            if (res.ok) {
                // Remove row from UI
                document.querySelector(`tr[data-id="${id}"]`).remove();
            } else {
                alert('Error deleting member');
            }
        } catch (e) {
            alert('Network error');
        }
    }
    function changeDay(delta) {
        const dateInput = document.getElementById('dateInput');
        const currentDate = new Date(dateInput.value);
        currentDate.setDate(currentDate.getDate() + delta);
        dateInput.value = currentDate.toISOString().split('T')[0];
        window.location.href = `/attendance?date=${dateInput.value}`;
    }

    document.getElementById('dateInput').addEventListener('change', (e) => {
        window.location.href = `/attendance?date=${e.target.value}`;
    });

    // Store selected statuses in memory
    const changes = {};

    function selectStatus(memberId, status) {
        console.log("Selecting:", memberId, status);
        // Find the specific row for this member
        const row = document.querySelector(`tr[data-id="${memberId}"]`);
        if (!row) {
            console.error("Row not found for member:", memberId);
            return;
        }

        const btnGroup = row.querySelector('.status-buttons');
        if (!btnGroup) {
            console.error("Button group not found in row:", memberId);
            return;
        }

        // Deactivate all buttons ONLY in this specific group
        const buttons = btnGroup.querySelectorAll('.status-btn');
        buttons.forEach(btn => {
            btn.classList.remove('active');
        });

        // Activate the target button
        const statusClass = status.toLowerCase();
        const targetBtn = btnGroup.querySelector(`.${statusClass}`);
        if (targetBtn) {
            targetBtn.classList.add('active');
            console.log("Activated button:", statusClass);
        } else {
            console.error("Target button not found:", statusClass);
        }

        // Record change
        changes[memberId] = status;

        // Enable Save Button visual feedback if needed
        const saveBtn = document.getElementById('submitAttendanceBtn');
        if (saveBtn) saveBtn.innerText = "Save Changes *";
    }

    async function submitAttendance() {
        const date = document.getElementById('dateInput').value;
        const btn = document.getElementById('submitAttendanceBtn');

        const payload = [];

        // Find all rows
        document.querySelectorAll('tr[data-id]').forEach(row => {
            const memberId = row.getAttribute('data-id');
            // Find active button
            const activeBtn = row.querySelector('.status-btn.active');
            let status = null;
            if (activeBtn) {
                if (activeBtn.classList.contains('jooga')) status = 'Jooga';
                if (activeBtn.classList.contains('maqan')) status = 'Maqan';
                if (activeBtn.classList.contains('fasax')) status = 'Fasax';
            }

            if (status) {
                payload.push({ member_id: memberId, status: status });
            }
        });

        if (payload.length === 0) return alert("No attendance marked.");

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

        try {
            const promises = payload.map(item => {
                return fetch('/api/mark_attendance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ member_id: item.member_id, status: item.status, date: date })
                });
            });

            await Promise.all(promises);
            location.reload();

        } catch (e) {
            alert('Error saving attendance');
            btn.disabled = false;
            btn.innerText = 'Save Attendance';
        }
    }
    async function finishMeeting(meetingId) {
        if (!confirm('Ma hubtaa inaad rabto inaad dhameystirto kulankan? (Finish Meeting)')) return;

        try {
            const res = await fetch('/api/finish_meeting', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ meeting_id: meetingId })
            });
            if (res.ok) {
                window.location.href = '/history';
            } else {
                alert('Error finishing meeting');
            }
        } catch (e) {
            alert('Network error');
        }
    }
</script>

<style>
    .btn-finish {
        background: linear-gradient(135deg, #10b981, #059669);
        border: none;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        font-family: inherit;
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        margin-left: 0.5rem;
    }

    .btn-finish:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
    }
</style>
{% endblock %}